name: G-Deployment

on:
  push:
    tags: ["deployment**"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    steps:
    - name: checkout_for_testing
      uses: actions/checkout@v3
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm ci
    - run: npm test
  gcp:
    runs-on: ubuntu-latest
    steps:
      - name: checkout_for_deployment
        uses: actions/checkout@v3
      - name: setup_gcloud
        uses: GoogleCloudPlatform/github-actions/setup-gcloud@v0
        with:
          service_account_email: ${{ secrets.GCP_EMAIL }}
          service_account_key: ${{ secrets.GCP_EMAIL }}
          enable_default_credentials: true
      - name: configure_docker
        run: gcloud auth configure-docker
      - name: build_and_publish
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT }}/${{ secrets.GCP_APPLICATION }}
          gcloud config set run/region europe-west1
      - name: Deploy
        run: |
          gcloud run deploy ${{ secrets.GCP_APPLICATION }} --image gcr.io/${{ secrets.GCP_PROJECT }}/${{ secrets.GCP_APPLICATION }} \
            --platform managed \
            --max-instances 100 \
            --timeout 5m \
            --allow-unauthenticated \
            --memory 256M \
            --service-account hafas-rest-service@hosting-351419.iam.gserviceaccount.com